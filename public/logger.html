<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>å¾®ä¿¡æœåŠ¡å·ç®¡ç†åå°</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    :root {
      --primary: #1890ff;
      --success: #52c41a;
      --warning: #faad14;
      --error: #ff4d4f;
      --bg-dark: #001529;
      --bg-light: #f0f2f5;
      --text-dark: #333;
      --text-light: #666;
      --border: #e8e8e8;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      background: var(--bg-light);
      min-height: 100vh;
    }
    
    /* é¡¶éƒ¨å¯¼èˆª */
    .header {
      background: var(--bg-dark);
      color: white;
      padding: 0 24px;
      height: 64px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      z-index: 100;
    }
    
    .header h1 {
      font-size: 20px;
      font-weight: 500;
    }
    
    .header-right {
      display: flex;
      align-items: center;
      gap: 16px;
    }
    
    .status-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: var(--success);
      animation: pulse 2s infinite;
    }
    
    .status-dot.disconnected {
      background: var(--error);
      animation: none;
    }
    
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }
    
    /* ä¸»å®¹å™¨ */
    .container {
      margin-top: 64px;
      display: flex;
      min-height: calc(100vh - 64px);
    }
    
    /* ä¾§è¾¹æ  */
    .sidebar {
      width: 200px;
      background: var(--bg-dark);
      padding-top: 16px;
      position: fixed;
      top: 64px;
      bottom: 0;
      left: 0;
    }
    
    .menu-item {
      padding: 12px 24px;
      color: rgba(255,255,255,0.65);
      cursor: pointer;
      transition: all 0.3s;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .menu-item:hover, .menu-item.active {
      color: white;
      background: var(--primary);
    }
    
    .menu-item .icon {
      font-size: 16px;
    }
    
    /* å†…å®¹åŒº */
    .content {
      flex: 1;
      margin-left: 200px;
      padding: 24px;
    }
    
    /* ç»Ÿè®¡å¡ç‰‡ */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 16px;
      margin-bottom: 24px;
    }
    
    .stat-card {
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 1px 2px rgba(0,0,0,0.1);
    }
    
    .stat-card .label {
      color: var(--text-light);
      font-size: 14px;
      margin-bottom: 8px;
    }
    
    .stat-card .value {
      font-size: 28px;
      font-weight: 600;
      color: var(--text-dark);
    }
    
    .stat-card .sub {
      font-size: 12px;
      color: var(--text-light);
      margin-top: 4px;
    }
    
    /* é¢æ¿ */
    .panel {
      background: white;
      border-radius: 8px;
      box-shadow: 0 1px 2px rgba(0,0,0,0.1);
      margin-bottom: 24px;
    }
    
    .panel-header {
      padding: 16px 20px;
      border-bottom: 1px solid var(--border);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .panel-title {
      font-size: 16px;
      font-weight: 500;
    }
    
    .panel-body {
      padding: 16px 20px;
    }
    
    /* å·¥å…·æ  */
    .toolbar {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
      align-items: center;
    }
    
    .toolbar select, .toolbar input {
      padding: 6px 12px;
      border: 1px solid var(--border);
      border-radius: 4px;
      font-size: 14px;
    }
    
    .btn {
      padding: 6px 16px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      transition: all 0.3s;
    }
    
    .btn-primary {
      background: var(--primary);
      color: white;
    }
    
    .btn-primary:hover {
      background: #40a9ff;
    }
    
    .btn-default {
      background: white;
      border: 1px solid var(--border);
      color: var(--text-dark);
    }
    
    .btn-default:hover {
      border-color: var(--primary);
      color: var(--primary);
    }
    
    /* è¡¨æ ¼ */
    .table-container {
      overflow-x: auto;
    }
    
    table {
      width: 100%;
      border-collapse: collapse;
    }
    
    th, td {
      padding: 12px;
      text-align: left;
      border-bottom: 1px solid var(--border);
    }
    
    th {
      background: #fafafa;
      font-weight: 500;
      color: var(--text-dark);
    }
    
    tr:hover {
      background: #f5f5f5;
    }
    
    /* æ ‡ç­¾ */
    .tag {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 4px;
      font-size: 12px;
    }
    
    .tag-success { background: #f6ffed; color: var(--success); border: 1px solid #b7eb8f; }
    .tag-error { background: #fff2f0; color: var(--error); border: 1px solid #ffccc7; }
    .tag-warning { background: #fffbe6; color: var(--warning); border: 1px solid #ffe58f; }
    .tag-info { background: #e6f7ff; color: var(--primary); border: 1px solid #91d5ff; }
    .tag-default { background: #fafafa; color: var(--text-light); border: 1px solid var(--border); }
    
    /* ä¼šè¯åˆ—è¡¨ */
    .conversation-container {
      display: flex;
      gap: 16px;
      height: 600px;
    }
    
    .user-list {
      width: 280px;
      border-right: 1px solid var(--border);
      overflow-y: auto;
    }
    
    .user-item {
      padding: 12px 16px;
      border-bottom: 1px solid var(--border);
      cursor: pointer;
      transition: background 0.3s;
    }
    
    .user-item:hover, .user-item.active {
      background: #e6f7ff;
    }
    
    .user-item .uid {
      font-size: 14px;
      color: var(--text-dark);
      font-family: monospace;
    }
    
    .user-item .meta {
      font-size: 12px;
      color: var(--text-light);
      margin-top: 4px;
      display: flex;
      justify-content: space-between;
    }
    
    .chat-panel {
      flex: 1;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }
    
    .chat-header {
      padding: 12px 16px;
      border-bottom: 1px solid var(--border);
      font-weight: 500;
    }
    
    .chat-messages {
      flex: 1;
      overflow-y: auto;
      padding: 16px;
    }
    
    .message {
      margin-bottom: 16px;
      display: flex;
    }
    
    .message.user {
      justify-content: flex-end;
    }
    
    .message-bubble {
      max-width: 70%;
      padding: 10px 14px;
      border-radius: 8px;
      font-size: 14px;
      line-height: 1.5;
    }
    
    .message.user .message-bubble {
      background: var(--primary);
      color: white;
      border-bottom-right-radius: 2px;
    }
    
    .message.assistant .message-bubble {
      background: #f0f0f0;
      color: var(--text-dark);
      border-bottom-left-radius: 2px;
    }
    
    .message-time {
      font-size: 11px;
      color: var(--text-light);
      margin-top: 4px;
    }
    
    /* åˆ†é¡µ */
    .pagination {
      display: flex;
      justify-content: center;
      gap: 8px;
      margin-top: 16px;
    }
    
    .pagination button {
      padding: 6px 12px;
      border: 1px solid var(--border);
      background: white;
      border-radius: 4px;
      cursor: pointer;
    }
    
    .pagination button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    
    .pagination button.active {
      background: var(--primary);
      color: white;
      border-color: var(--primary);
    }
    
    /* åŠ è½½çŠ¶æ€ */
    .loading {
      text-align: center;
      padding: 40px;
      color: var(--text-light);
    }
    
    .spinner {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 2px solid var(--border);
      border-top-color: var(--primary);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    /* ç©ºçŠ¶æ€ */
    .empty {
      text-align: center;
      padding: 60px 20px;
      color: var(--text-light);
    }
    
    .empty .icon {
      font-size: 48px;
      margin-bottom: 16px;
    }
    
    /* è¯¦æƒ…å¼¹çª— */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }
    
    .modal {
      background: white;
      border-radius: 8px;
      max-width: 600px;
      width: 90%;
      max-height: 80vh;
      overflow: auto;
    }
    
    .modal-header {
      padding: 16px 20px;
      border-bottom: 1px solid var(--border);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .modal-close {
      background: none;
      border: none;
      font-size: 20px;
      cursor: pointer;
      color: var(--text-light);
    }
    
    .modal-body {
      padding: 20px;
    }
    
    .detail-row {
      display: flex;
      margin-bottom: 12px;
    }
    
    .detail-label {
      width: 100px;
      color: var(--text-light);
      flex-shrink: 0;
    }
    
    .detail-value {
      flex: 1;
      word-break: break-all;
    }
    
    pre {
      background: #f5f5f5;
      padding: 12px;
      border-radius: 4px;
      overflow-x: auto;
      font-size: 13px;
    }
    
    /* éšè— */
    .hidden {
      display: none !important;
    }
    
    /* å“åº”å¼ */
    @media (max-width: 768px) {
      .sidebar {
        display: none;
      }
      .content {
        margin-left: 0;
      }
      .conversation-container {
        flex-direction: column;
        height: auto;
      }
      .user-list {
        width: 100%;
        border-right: none;
        border-bottom: 1px solid var(--border);
        max-height: 300px;
      }
    }
  </style>
</head>
<body>
  <!-- é¡¶éƒ¨å¯¼èˆª -->
  <header class="header">
    <h1>ğŸ”§ å¾®ä¿¡æœåŠ¡å·ç®¡ç†åå°</h1>
    <div class="header-right">
      <span id="connStatus">
        <span class="status-dot" id="statusDot"></span>
        <span id="statusText">å®æ—¶</span>
      </span>
      <button class="btn btn-default" onclick="logout()">é€€å‡º</button>
    </div>
  </header>
  
  <div class="container">
    <!-- ä¾§è¾¹æ  -->
    <aside class="sidebar">
      <div class="menu-item active" data-page="overview" onclick="switchPage('overview')">
        <span class="icon">ğŸ“Š</span>
        <span>ç³»ç»Ÿæ¦‚è§ˆ</span>
      </div>
      <div class="menu-item" data-page="sessions" onclick="switchPage('sessions')">
        <span class="icon">ğŸ”„</span>
        <span>ä¼šè¯æµæ°´</span>
      </div>
      <div class="menu-item" data-page="logs" onclick="switchPage('logs')">
        <span class="icon">ğŸ“</span>
        <span>è¯·æ±‚æ—¥å¿—</span>
      </div>
      <div class="menu-item" data-page="conversations" onclick="switchPage('conversations')">
        <span class="icon">ğŸ’¬</span>
        <span>ä¼šè¯è®°å½•</span>
      </div>
      <div class="menu-item" data-page="users" onclick="switchPage('users')">
        <span class="icon">ğŸ‘¥</span>
        <span>ç”¨æˆ·ç®¡ç†</span>
      </div>
      <div class="menu-item" data-page="auth" onclick="switchPage('auth')">
        <span class="icon">ğŸ”</span>
        <span>è®¤è¯è®°å½•</span>
      </div>
    </aside>
    
    <!-- å†…å®¹åŒº -->
    <main class="content">
      <!-- æ¦‚è§ˆé¡µ -->
      <section id="page-overview" class="page">
        <div class="stats-grid" id="statsGrid">
          <div class="stat-card">
            <div class="label">ä»Šæ—¥è¯·æ±‚</div>
            <div class="value" id="statTodayRequests">-</div>
            <div class="sub">æ€»è®¡: <span id="statTotalRequests">-</span></div>
          </div>
          <div class="stat-card">
            <div class="label">æ´»è·ƒç”¨æˆ·</div>
            <div class="value" id="statActiveUsers">-</div>
            <div class="sub">24å°æ—¶å†… / æ€»è®¡: <span id="statTotalUsers">-</span></div>
          </div>
          <div class="stat-card">
            <div class="label">ä»Šæ—¥LLMè°ƒç”¨</div>
            <div class="value" id="statTodayLLM">-</div>
            <div class="sub">æ€»è®¡: <span id="statTotalLLM">-</span></div>
          </div>
          <div class="stat-card">
            <div class="label">ä»Šæ—¥è®¤è¯</div>
            <div class="value" id="statTodayAuth">-</div>
            <div class="sub">æ€»è®¡: <span id="statTotalAuth">-</span></div>
          </div>
        </div>
        
        <div class="panel">
          <div class="panel-header">
            <span class="panel-title">å®æ—¶æ—¥å¿—</span>
            <button class="btn btn-default" onclick="clearRealtimeLogs()">æ¸…ç©º</button>
          </div>
          <div class="panel-body">
            <div class="table-container">
              <table>
                <thead>
                  <tr>
                    <th>æ—¶é—´</th>
                    <th>ç±»å‹</th>
                    <th>ç”¨æˆ·</th>
                    <th>çŠ¶æ€</th>
                    <th>è€—æ—¶</th>
                  </tr>
                </thead>
                <tbody id="realtimeLogs">
                  <tr>
                    <td colspan="5" class="empty">ç­‰å¾…æ–°æ—¥å¿—...</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </section>
      
      <!-- ä¼šè¯æµæ°´é¡µï¼ˆèšåˆæ—¥å¿—ï¼‰ -->
      <section id="page-sessions" class="page hidden">
        <div class="panel">
          <div class="panel-header">
            <span class="panel-title">ä¼šè¯æµæ°´ï¼ˆæ¯æ¬¡å¯¹è¯ä¸€æ¡è®°å½•ï¼‰</span>
            <div class="toolbar">
              <select id="sessionMsgTypeFilter" onchange="loadSessions()">
                <option value="">å…¨éƒ¨ç±»å‹</option>
                <option value="text">æ–‡æœ¬å¯¹è¯</option>
                <option value="command">å¿«æ·å‘½ä»¤</option>
                <option value="event">äº‹ä»¶</option>
              </select>
              <input type="text" id="sessionUidFilter" placeholder="ç”¨æˆ·ID" onkeyup="if(event.key==='Enter')loadSessions()">
              <button class="btn btn-primary" onclick="loadSessions()">æŸ¥è¯¢</button>
              <button class="btn btn-default" onclick="exportSessions()">å¯¼å‡º</button>
            </div>
          </div>
          <div class="panel-body">
            <div class="table-container">
              <table>
                <thead>
                  <tr>
                    <th>ID</th>
                    <th>æ—¶é—´</th>
                    <th>ç±»å‹</th>
                    <th>ç”¨æˆ·</th>
                    <th>è¾“å…¥</th>
                    <th>è¾“å‡º</th>
                    <th>æ€»è€—æ—¶</th>
                    <th>æ­¥éª¤</th>
                    <th>çŠ¶æ€</th>
                    <th>æ“ä½œ</th>
                  </tr>
                </thead>
                <tbody id="sessionsTable">
                  <tr><td colspan="10" class="loading"><span class="spinner"></span> åŠ è½½ä¸­...</td></tr>
                </tbody>
              </table>
            </div>
            <div class="pagination" id="sessionsPagination"></div>
          </div>
        </div>
      </section>
      
      <!-- æ—¥å¿—é¡µ -->
      <section id="page-logs" class="page hidden">
        <div class="panel">
          <div class="panel-header">
            <span class="panel-title">è¯·æ±‚æ—¥å¿—</span>
            <div class="toolbar">
              <select id="logTypeFilter" onchange="loadLogs()">
                <option value="">å…¨éƒ¨ç±»å‹</option>
                <option value="wx_text">å¾®ä¿¡æ–‡æœ¬</option>
                <option value="wx_event">å¾®ä¿¡äº‹ä»¶</option>
                <option value="llm_call">LLMè°ƒç”¨</option>
                <option value="oauth_scan">æ‰«ç è®¤è¯</option>
                <option value="oauth_code">éªŒè¯ç è®¤è¯</option>
                <option value="error">é”™è¯¯</option>
              </select>
              <input type="text" id="logUidFilter" placeholder="ç”¨æˆ·ID" onkeyup="if(event.key==='Enter')loadLogs()">
              <button class="btn btn-primary" onclick="loadLogs()">æŸ¥è¯¢</button>
              <button class="btn btn-default" onclick="exportLogs()">å¯¼å‡º</button>
            </div>
          </div>
          <div class="panel-body">
            <div class="table-container">
              <table>
                <thead>
                  <tr>
                    <th>ID</th>
                    <th>æ—¶é—´</th>
                    <th>ç±»å‹</th>
                    <th>ç”¨æˆ·</th>
                    <th>è·¯å¾„</th>
                    <th>çŠ¶æ€</th>
                    <th>è€—æ—¶</th>
                    <th>æ“ä½œ</th>
                  </tr>
                </thead>
                <tbody id="logsTable">
                  <tr><td colspan="8" class="loading"><span class="spinner"></span> åŠ è½½ä¸­...</td></tr>
                </tbody>
              </table>
            </div>
            <div class="pagination" id="logsPagination"></div>
          </div>
        </div>
      </section>
      
      <!-- ä¼šè¯é¡µ -->
      <section id="page-conversations" class="page hidden">
        <div class="panel">
          <div class="panel-header">
            <span class="panel-title">ä¼šè¯è®°å½•</span>
          </div>
          <div class="panel-body">
            <div class="conversation-container">
              <div class="user-list" id="conversationUserList">
                <div class="loading"><span class="spinner"></span> åŠ è½½ä¸­...</div>
              </div>
              <div class="chat-panel">
                <div class="chat-header" id="chatHeader">é€‰æ‹©ç”¨æˆ·æŸ¥çœ‹å¯¹è¯</div>
                <div class="chat-messages" id="chatMessages">
                  <div class="empty">
                    <div class="icon">ğŸ’¬</div>
                    <div>è¯·ä»å·¦ä¾§é€‰æ‹©ä¸€ä¸ªç”¨æˆ·</div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </section>
      
      <!-- ç”¨æˆ·é¡µ -->
      <section id="page-users" class="page hidden">
        <div class="panel">
          <div class="panel-header">
            <span class="panel-title">ç”¨æˆ·ç®¡ç†</span>
            <div class="toolbar">
              <select id="userStatusFilter" onchange="loadUsers()">
                <option value="">å…¨éƒ¨çŠ¶æ€</option>
                <option value="active">æ­£å¸¸</option>
                <option value="banned">å·²å°ç¦</option>
              </select>
              <button class="btn btn-primary" onclick="loadUsers()">åˆ·æ–°</button>
            </div>
          </div>
          <div class="panel-body">
            <div class="table-container">
              <table>
                <thead>
                  <tr>
                    <th>ç”¨æˆ·ID</th>
                    <th>é¦–æ¬¡å‡ºç°</th>
                    <th>æœ€åæ´»è·ƒ</th>
                    <th>æ¶ˆæ¯æ•°</th>
                    <th>Tokenæ¶ˆè€—</th>
                    <th>è®¤è¯æ¬¡æ•°</th>
                    <th>çŠ¶æ€</th>
                    <th>æ“ä½œ</th>
                  </tr>
                </thead>
                <tbody id="usersTable">
                  <tr><td colspan="8" class="loading"><span class="spinner"></span> åŠ è½½ä¸­...</td></tr>
                </tbody>
              </table>
            </div>
            <div class="pagination" id="usersPagination"></div>
          </div>
        </div>
      </section>
      
      <!-- è®¤è¯é¡µ -->
      <section id="page-auth" class="page hidden">
        <div class="panel">
          <div class="panel-header">
            <span class="panel-title">è®¤è¯è®°å½•</span>
            <div class="toolbar">
              <select id="authTypeFilter" onchange="loadAuthLogs()">
                <option value="">å…¨éƒ¨ç±»å‹</option>
                <option value="scan">æ‰«ç </option>
                <option value="code">éªŒè¯ç </option>
              </select>
              <select id="authSuccessFilter" onchange="loadAuthLogs()">
                <option value="">å…¨éƒ¨ç»“æœ</option>
                <option value="true">æˆåŠŸ</option>
                <option value="false">å¤±è´¥</option>
              </select>
              <button class="btn btn-primary" onclick="loadAuthLogs()">æŸ¥è¯¢</button>
            </div>
          </div>
          <div class="panel-body">
            <div class="table-container">
              <table>
                <thead>
                  <tr>
                    <th>ID</th>
                    <th>æ—¶é—´</th>
                    <th>ç”¨æˆ·</th>
                    <th>ç±»å‹</th>
                    <th>ç»“æœ</th>
                    <th>IP</th>
                  </tr>
                </thead>
                <tbody id="authTable">
                  <tr><td colspan="6" class="loading"><span class="spinner"></span> åŠ è½½ä¸­...</td></tr>
                </tbody>
              </table>
            </div>
            <div class="pagination" id="authPagination"></div>
          </div>
        </div>
      </section>
    </main>
  </div>
  
  <!-- è¯¦æƒ…å¼¹çª— -->
  <div id="modalOverlay" class="modal-overlay hidden" onclick="closeModal(event)">
    <div class="modal" onclick="event.stopPropagation()">
      <div class="modal-header">
        <span id="modalTitle">è¯¦æƒ…</span>
        <button class="modal-close" onclick="closeModal()">&times;</button>
      </div>
      <div class="modal-body" id="modalBody"></div>
    </div>
  </div>

  <script>
    // é…ç½®
    const TOKEN = new URLSearchParams(window.location.search).get('token') || '';
    const API_BASE = '/logger/api';
    let eventSource = null;
    let currentPage = 'overview';
    let logsOffset = 0;
    let usersOffset = 0;
    let authOffset = 0;
    let sessionsOffset = 0;
    const PAGE_SIZE = 20;
    
    // APIè¯·æ±‚
    async function api(path, options = {}) {
      const url = new URL(API_BASE + path, window.location.origin);
      url.searchParams.set('token', TOKEN);
      const res = await fetch(url, options);
      return res.json();
    }
    
    // æ ¼å¼åŒ–æ—¶é—´
    function formatTime(ts) {
      const d = new Date(ts);
      return d.toLocaleString('zh-CN', { hour12: false });
    }
    
    function formatTimeShort(ts) {
      const d = new Date(ts);
      return d.toLocaleTimeString('zh-CN', { hour12: false });
    }
    
    function formatRelative(ts) {
      const diff = Date.now() - ts;
      if (diff < 60000) return 'åˆšåˆš';
      if (diff < 3600000) return Math.floor(diff / 60000) + 'åˆ†é’Ÿå‰';
      if (diff < 86400000) return Math.floor(diff / 3600000) + 'å°æ—¶å‰';
      return Math.floor(diff / 86400000) + 'å¤©å‰';
    }
    
    // æˆªæ–­UIDæ˜¾ç¤º
    function shortUid(uid) {
      if (!uid) return '-';
      if (uid.length <= 12) return uid;
      return uid.substring(0, 6) + '...' + uid.substring(uid.length - 4);
    }
    
    // æ—¥å¿—ç±»å‹æ ‡ç­¾
    function logTypeTag(type) {
      const map = {
        'wx_text': ['å¾®ä¿¡æ–‡æœ¬', 'tag-info'],
        'wx_event': ['å¾®ä¿¡äº‹ä»¶', 'tag-warning'],
        'wx_image': ['å¾®ä¿¡å›¾ç‰‡', 'tag-info'],
        'wx_voice': ['å¾®ä¿¡è¯­éŸ³', 'tag-info'],
        'llm_call': ['LLMè°ƒç”¨', 'tag-success'],
        'oauth_scan': ['æ‰«ç è®¤è¯', 'tag-warning'],
        'oauth_code': ['éªŒè¯ç ', 'tag-warning'],
        'oauth_check': ['è®¤è¯æ£€æŸ¥', 'tag-default'],
        'admin': ['ç®¡ç†æ“ä½œ', 'tag-info'],
        'error': ['é”™è¯¯', 'tag-error']
      };
      const [text, cls] = map[type] || [type, 'tag-default'];
      return `<span class="tag ${cls}">${text}</span>`;
    }
    
    // çŠ¶æ€ç æ ‡ç­¾
    function statusTag(status) {
      if (!status) return '-';
      if (status >= 200 && status < 300) return `<span class="tag tag-success">${status}</span>`;
      if (status >= 400) return `<span class="tag tag-error">${status}</span>`;
      return `<span class="tag tag-warning">${status}</span>`;
    }
    
    // åˆ‡æ¢é¡µé¢
    function switchPage(page) {
      currentPage = page;
      document.querySelectorAll('.menu-item').forEach(el => {
        el.classList.toggle('active', el.dataset.page === page);
      });
      document.querySelectorAll('.page').forEach(el => {
        el.classList.toggle('hidden', el.id !== 'page-' + page);
      });
      
      // åŠ è½½æ•°æ®
      if (page === 'overview') loadStats();
      else if (page === 'sessions') loadSessions();
      else if (page === 'logs') loadLogs();
      else if (page === 'conversations') loadConversations();
      else if (page === 'users') loadUsers();
      else if (page === 'auth') loadAuthLogs();
    }
    
    // åŠ è½½ç»Ÿè®¡ä¿¡æ¯
    async function loadStats() {
      try {
        const res = await api('/stats');
        if (res.code === 200) {
          const d = res.data;
          document.getElementById('statTodayRequests').textContent = d.todayRequests;
          document.getElementById('statTotalRequests').textContent = d.totalRequests;
          document.getElementById('statActiveUsers').textContent = d.activeUsers;
          document.getElementById('statTotalUsers').textContent = d.totalUsers;
          document.getElementById('statTodayLLM').textContent = d.todayLLMCalls;
          document.getElementById('statTotalLLM').textContent = d.totalLLMCalls;
          document.getElementById('statTodayAuth').textContent = d.todayAuthCount;
          document.getElementById('statTotalAuth').textContent = d.totalAuthCount;
        }
      } catch (e) {
        console.error('åŠ è½½ç»Ÿè®¡å¤±è´¥:', e);
      }
    }
    
    // åŠ è½½æ—¥å¿—
    async function loadLogs() {
      const type = document.getElementById('logTypeFilter').value;
      const uid = document.getElementById('logUidFilter').value;
      
      let path = `/logs?limit=${PAGE_SIZE}&offset=${logsOffset}`;
      if (type) path += `&type=${type}`;
      if (uid) path += `&uid=${encodeURIComponent(uid)}`;
      
      try {
        const res = await api(path);
        if (res.code === 200) {
          renderLogsTable(res.data);
        }
      } catch (e) {
        console.error('åŠ è½½æ—¥å¿—å¤±è´¥:', e);
      }
    }
    
    function renderLogsTable(logs) {
      const tbody = document.getElementById('logsTable');
      if (!logs || logs.length === 0) {
        tbody.innerHTML = '<tr><td colspan="8" class="empty">æš‚æ— æ•°æ®</td></tr>';
        return;
      }
      
      tbody.innerHTML = logs.map(log => `
        <tr>
          <td>${log.id}</td>
          <td>${formatTime(log.timestamp)}</td>
          <td>${logTypeTag(log.type)}</td>
          <td title="${log.uid || ''}">${shortUid(log.uid)}</td>
          <td>${log.path || '-'}</td>
          <td>${statusTag(log.status)}</td>
          <td>${log.duration ? log.duration + 'ms' : '-'}</td>
          <td><button class="btn btn-default" onclick="showLogDetail(${log.id})">è¯¦æƒ…</button></td>
        </tr>
      `).join('');
    }
    
    // æ˜¾ç¤ºæ—¥å¿—è¯¦æƒ…
    async function showLogDetail(id) {
      try {
        const res = await api(`/logs/${id}`);
        if (res.code === 200) {
          const log = res.data;
          document.getElementById('modalTitle').textContent = `æ—¥å¿—è¯¦æƒ… #${id}`;
          document.getElementById('modalBody').innerHTML = `
            <div class="detail-row"><div class="detail-label">ID</div><div class="detail-value">${log.id}</div></div>
            <div class="detail-row"><div class="detail-label">æ—¶é—´</div><div class="detail-value">${formatTime(log.timestamp)}</div></div>
            <div class="detail-row"><div class="detail-label">ç±»å‹</div><div class="detail-value">${logTypeTag(log.type)}</div></div>
            <div class="detail-row"><div class="detail-label">ç”¨æˆ·ID</div><div class="detail-value">${log.uid || '-'}</div></div>
            <div class="detail-row"><div class="detail-label">è¯·æ±‚æ–¹æ³•</div><div class="detail-value">${log.method || '-'}</div></div>
            <div class="detail-row"><div class="detail-label">è·¯å¾„</div><div class="detail-value">${log.path || '-'}</div></div>
            <div class="detail-row"><div class="detail-label">çŠ¶æ€ç </div><div class="detail-value">${statusTag(log.status)}</div></div>
            <div class="detail-row"><div class="detail-label">è€—æ—¶</div><div class="detail-value">${log.duration ? log.duration + 'ms' : '-'}</div></div>
            <div class="detail-row"><div class="detail-label">IP</div><div class="detail-value">${log.ip || '-'}</div></div>
            <div class="detail-row"><div class="detail-label">User-Agent</div><div class="detail-value">${log.userAgent || '-'}</div></div>
            ${log.requestBody ? `<div class="detail-row"><div class="detail-label">è¯·æ±‚ä½“</div><div class="detail-value"><pre>${formatJson(log.requestBody)}</pre></div></div>` : ''}
            ${log.responseBody ? `<div class="detail-row"><div class="detail-label">å“åº”ä½“</div><div class="detail-value"><pre>${formatJson(log.responseBody)}</pre></div></div>` : ''}
            ${log.extra ? `<div class="detail-row"><div class="detail-label">æ‰©å±•ä¿¡æ¯</div><div class="detail-value"><pre>${formatJson(log.extra)}</pre></div></div>` : ''}
          `;
          document.getElementById('modalOverlay').classList.remove('hidden');
        }
      } catch (e) {
        console.error('åŠ è½½è¯¦æƒ…å¤±è´¥:', e);
      }
    }
    
    function formatJson(str) {
      try {
        return JSON.stringify(JSON.parse(str), null, 2);
      } catch {
        return str;
      }
    }
    
    // å¯¼å‡ºæ—¥å¿—
    function exportLogs() {
      const type = document.getElementById('logTypeFilter').value;
      const uid = document.getElementById('logUidFilter').value;
      let url = `/logger/api/logs/export?token=${TOKEN}`;
      if (type) url += `&type=${type}`;
      if (uid) url += `&uid=${encodeURIComponent(uid)}`;
      window.open(url, '_blank');
    }
    
    // åŠ è½½ä¼šè¯
    async function loadConversations() {
      try {
        const res = await api('/conversations');
        if (res.code === 200) {
          renderConversationList(res.data);
        }
      } catch (e) {
        console.error('åŠ è½½ä¼šè¯å¤±è´¥:', e);
      }
    }
    
    function renderConversationList(conversations) {
      const container = document.getElementById('conversationUserList');
      if (!conversations || conversations.length === 0) {
        container.innerHTML = '<div class="empty">æš‚æ— ä¼šè¯</div>';
        return;
      }
      
      container.innerHTML = conversations.map(c => `
        <div class="user-item" onclick="loadConversationDetail('${c.uid}', this)">
          <div class="uid">${shortUid(c.uid)}</div>
          <div class="meta">
            <span>${c.msgCount}æ¡æ¶ˆæ¯</span>
            <span>${formatRelative(c.lastTime)}</span>
          </div>
        </div>
      `).join('');
    }
    
    async function loadConversationDetail(uid, el) {
      // é«˜äº®é€‰ä¸­
      document.querySelectorAll('.user-item').forEach(e => e.classList.remove('active'));
      if (el) el.classList.add('active');
      
      document.getElementById('chatHeader').textContent = uid;
      document.getElementById('chatMessages').innerHTML = '<div class="loading"><span class="spinner"></span> åŠ è½½ä¸­...</div>';
      
      try {
        const res = await api(`/conversations/${encodeURIComponent(uid)}`);
        if (res.code === 200) {
          renderMessages(res.data);
        }
      } catch (e) {
        console.error('åŠ è½½å¯¹è¯å¤±è´¥:', e);
      }
    }
    
    function renderMessages(messages) {
      const container = document.getElementById('chatMessages');
      if (!messages || messages.length === 0) {
        container.innerHTML = '<div class="empty">æš‚æ— æ¶ˆæ¯</div>';
        return;
      }
      
      container.innerHTML = messages.map(m => `
        <div class="message ${m.role}">
          <div>
            <div class="message-bubble">${escapeHtml(m.content)}</div>
            <div class="message-time">${formatTime(m.timestamp)}${m.duration ? ` Â· ${m.duration}ms` : ''}</div>
          </div>
        </div>
      `).join('');
      
      container.scrollTop = container.scrollHeight;
    }
    
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML.replace(/\n/g, '<br>');
    }
    
    // åŠ è½½ç”¨æˆ·
    async function loadUsers() {
      const status = document.getElementById('userStatusFilter').value;
      let path = `/users?limit=${PAGE_SIZE}&offset=${usersOffset}`;
      if (status) path += `&status=${status}`;
      
      try {
        const res = await api(path);
        if (res.code === 200) {
          renderUsersTable(res.data);
        }
      } catch (e) {
        console.error('åŠ è½½ç”¨æˆ·å¤±è´¥:', e);
      }
    }
    
    function renderUsersTable(users) {
      const tbody = document.getElementById('usersTable');
      if (!users || users.length === 0) {
        tbody.innerHTML = '<tr><td colspan="8" class="empty">æš‚æ— æ•°æ®</td></tr>';
        return;
      }
      
      tbody.innerHTML = users.map(u => `
        <tr>
          <td title="${u.uid}">${shortUid(u.uid)}</td>
          <td>${formatTime(u.firstSeen)}</td>
          <td>${formatRelative(u.lastSeen)}</td>
          <td>${u.msgCount}</td>
          <td>${u.llmTokens}</td>
          <td>${u.authCount}</td>
          <td>${u.status === 'banned' ? '<span class="tag tag-error">å·²å°ç¦</span>' : '<span class="tag tag-success">æ­£å¸¸</span>'}</td>
          <td>
            ${u.status === 'banned' 
              ? `<button class="btn btn-default" onclick="unbanUser('${u.uid}')">è§£å°</button>`
              : `<button class="btn btn-default" onclick="banUser('${u.uid}')">å°ç¦</button>`
            }
          </td>
        </tr>
      `).join('');
    }
    
    async function banUser(uid) {
      if (!confirm('ç¡®å®šè¦å°ç¦è¯¥ç”¨æˆ·å—?')) return;
      try {
        await api(`/users/${encodeURIComponent(uid)}/ban`, { method: 'POST' });
        loadUsers();
      } catch (e) {
        alert('æ“ä½œå¤±è´¥');
      }
    }
    
    async function unbanUser(uid) {
      if (!confirm('ç¡®å®šè¦è§£å°è¯¥ç”¨æˆ·å—?')) return;
      try {
        await api(`/users/${encodeURIComponent(uid)}/unban`, { method: 'POST' });
        loadUsers();
      } catch (e) {
        alert('æ“ä½œå¤±è´¥');
      }
    }
    
    // åŠ è½½è®¤è¯è®°å½•
    async function loadAuthLogs() {
      const authType = document.getElementById('authTypeFilter').value;
      const success = document.getElementById('authSuccessFilter').value;
      
      let path = `/auth?limit=${PAGE_SIZE}&offset=${authOffset}`;
      if (authType) path += `&authType=${authType}`;
      if (success) path += `&success=${success}`;
      
      try {
        const res = await api(path);
        if (res.code === 200) {
          renderAuthTable(res.data);
        }
      } catch (e) {
        console.error('åŠ è½½è®¤è¯è®°å½•å¤±è´¥:', e);
      }
    }
    
    function renderAuthTable(authLogs) {
      const tbody = document.getElementById('authTable');
      if (!authLogs || authLogs.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" class="empty">æš‚æ— æ•°æ®</td></tr>';
        return;
      }
      
      tbody.innerHTML = authLogs.map(a => `
        <tr>
          <td>${a.id}</td>
          <td>${formatTime(a.timestamp)}</td>
          <td title="${a.uid}">${shortUid(a.uid)}</td>
          <td><span class="tag tag-info">${a.authType}</span></td>
          <td>${a.success ? '<span class="tag tag-success">âœ“ æˆåŠŸ</span>' : '<span class="tag tag-error">âœ— å¤±è´¥</span>'}</td>
          <td>${a.ip || '-'}</td>
        </tr>
      `).join('');
    }
    
    // ============== ä¼šè¯æµæ°´ï¼ˆèšåˆæ—¥å¿—ï¼‰ ==============
    
    // æ¶ˆæ¯ç±»å‹æ ‡ç­¾
    function msgTypeTag(type) {
      const map = {
        'text': ['æ–‡æœ¬å¯¹è¯', 'tag-info'],
        'command': ['å¿«æ·å‘½ä»¤', 'tag-warning'],
        'event': ['äº‹ä»¶', 'tag-success'],
        'image': ['å›¾ç‰‡', 'tag-default'],
        'voice': ['è¯­éŸ³', 'tag-default']
      };
      const [text, cls] = map[type] || [type, 'tag-default'];
      return `<span class="tag ${cls}">${text}</span>`;
    }
    
    // é˜¶æ®µåç§°
    function stageName(stage) {
      const map = {
        'receive': 'æ¥æ”¶',
        'command': 'å‘½ä»¤æ£€æµ‹',
        'llm': 'LLMè°ƒç”¨',
        'db': 'æ•°æ®åº“',
        'send': 'å‘é€',
        'error': 'é”™è¯¯'
      };
      return map[stage] || stage;
    }
    
    // é˜¶æ®µæ ‡ç­¾
    function stageTag(step) {
      const name = stageName(step.stage);
      const cls = step.success ? 'tag-success' : (step.stage === 'error' ? 'tag-error' : 'tag-warning');
      const duration = step.duration ? ` ${step.duration}ms` : '';
      return `<span class="tag ${cls}">${name}${duration}</span>`;
    }
    
    // åŠ è½½ä¼šè¯æµæ°´
    async function loadSessions() {
      const msgType = document.getElementById('sessionMsgTypeFilter').value;
      const uid = document.getElementById('sessionUidFilter').value;
      
      let path = `/sessions?limit=${PAGE_SIZE}&offset=${sessionsOffset}`;
      if (msgType) path += `&msgType=${msgType}`;
      if (uid) path += `&uid=${encodeURIComponent(uid)}`;
      
      try {
        const res = await api(path);
        if (res.code === 200) {
          renderSessionsTable(res.data);
        }
      } catch (e) {
        console.error('åŠ è½½ä¼šè¯æµæ°´å¤±è´¥:', e);
      }
    }
    
    function renderSessionsTable(sessions) {
      const tbody = document.getElementById('sessionsTable');
      if (!sessions || sessions.length === 0) {
        tbody.innerHTML = '<tr><td colspan="10" class="empty">æš‚æ— æ•°æ®</td></tr>';
        return;
      }
      
      tbody.innerHTML = sessions.map(s => {
        const stepsPreview = (s.steps || []).map(step => stageTag(step)).join(' ');
        return `
          <tr>
            <td>${s.id}</td>
            <td>${formatTime(s.timestamp)}</td>
            <td>${msgTypeTag(s.msgType)}</td>
            <td title="${s.uid}">${shortUid(s.uid)}</td>
            <td title="${s.inputContent || ''}">${truncate(s.inputContent, 20)}</td>
            <td title="${s.outputContent || ''}">${truncate(s.outputContent, 20)}</td>
            <td>${s.totalDuration ? s.totalDuration + 'ms' : '-'}</td>
            <td>${stepsPreview}</td>
            <td>${statusTag(s.status)}</td>
            <td><button class="btn btn-default" onclick="showSessionDetail(${s.id})">è¯¦æƒ…</button></td>
          </tr>
        `;
      }).join('');
    }
    
    function truncate(str, len) {
      if (!str) return '-';
      if (str.length <= len) return escapeHtml(str);
      return escapeHtml(str.substring(0, len)) + '...';
    }
    
    // æ˜¾ç¤ºä¼šè¯æµæ°´è¯¦æƒ…
    async function showSessionDetail(id) {
      try {
        const res = await api(`/sessions/${id}`);
        if (res.code === 200) {
          const s = res.data;
          
          // æ„å»ºæ­¥éª¤è¯¦æƒ…
          let stepsHtml = '';
          if (s.steps && s.steps.length > 0) {
            stepsHtml = '<div style="margin-top: 12px;"><strong>å¤„ç†æ­¥éª¤ï¼š</strong></div>';
            stepsHtml += '<div style="margin-top: 8px;">';
            s.steps.forEach((step, idx) => {
              const statusIcon = step.success ? 'âœ“' : 'âœ—';
              const statusColor = step.success ? 'var(--success)' : 'var(--error)';
              stepsHtml += `
                <div style="padding: 8px; background: #f5f5f5; border-radius: 4px; margin-bottom: 8px;">
                  <div style="display: flex; justify-content: space-between; align-items: center;">
                    <span><strong>${idx + 1}. ${stageName(step.stage)}</strong></span>
                    <span style="color: ${statusColor}">${statusIcon} ${step.duration ? step.duration + 'ms' : ''}</span>
                  </div>
                  ${step.data ? `<pre style="margin: 8px 0 0 0; font-size: 12px;">${JSON.stringify(step.data, null, 2)}</pre>` : ''}
                  ${step.error ? `<div style="color: var(--error); margin-top: 4px;">é”™è¯¯: ${step.error}</div>` : ''}
                </div>
              `;
            });
            stepsHtml += '</div>';
          }
          
          document.getElementById('modalTitle').textContent = `ä¼šè¯è¯¦æƒ… #${id}`;
          document.getElementById('modalBody').innerHTML = `
            <div class="detail-row"><div class="detail-label">ä¼šè¯ID</div><div class="detail-value">${s.sessionId}</div></div>
            <div class="detail-row"><div class="detail-label">æ—¶é—´</div><div class="detail-value">${formatTime(s.timestamp)}</div></div>
            <div class="detail-row"><div class="detail-label">ç±»å‹</div><div class="detail-value">${msgTypeTag(s.msgType)}</div></div>
            <div class="detail-row"><div class="detail-label">ç”¨æˆ·ID</div><div class="detail-value">${s.uid}</div></div>
            <div class="detail-row"><div class="detail-label">çŠ¶æ€ç </div><div class="detail-value">${statusTag(s.status)}</div></div>
            <div class="detail-row"><div class="detail-label">æ€»è€—æ—¶</div><div class="detail-value">${s.totalDuration ? s.totalDuration + 'ms' : '-'}</div></div>
            <div class="detail-row"><div class="detail-label">IP</div><div class="detail-value">${s.ip || '-'}</div></div>
            <div class="detail-row"><div class="detail-label">User-Agent</div><div class="detail-value">${s.userAgent || '-'}</div></div>
            <div class="detail-row"><div class="detail-label">è¾“å…¥å†…å®¹</div><div class="detail-value"><pre>${escapeHtml(s.inputContent || '-')}</pre></div></div>
            <div class="detail-row"><div class="detail-label">è¾“å‡ºå†…å®¹</div><div class="detail-value"><pre>${escapeHtml(s.outputContent || '-')}</pre></div></div>
            ${stepsHtml}
          `;
          document.getElementById('modalOverlay').classList.remove('hidden');
        }
      } catch (e) {
        console.error('åŠ è½½è¯¦æƒ…å¤±è´¥:', e);
      }
    }
    
    // å¯¼å‡ºä¼šè¯æµæ°´
    function exportSessions() {
      const msgType = document.getElementById('sessionMsgTypeFilter').value;
      const uid = document.getElementById('sessionUidFilter').value;
      let url = `/logger/api/sessions/export?token=${TOKEN}`;
      if (msgType) url += `&msgType=${msgType}`;
      if (uid) url += `&uid=${encodeURIComponent(uid)}`;
      window.open(url, '_blank');
    }
    
    // å®æ—¶æ—¥å¿—
    function connectSSE() {
      if (eventSource) {
        eventSource.close();
      }
      
      eventSource = new EventSource(`/logger/sse?token=${TOKEN}`);
      
      eventSource.onopen = () => {
        document.getElementById('statusDot').classList.remove('disconnected');
        document.getElementById('statusText').textContent = 'å®æ—¶';
      };
      
      eventSource.onmessage = (event) => {
        try {
          const msg = JSON.parse(event.data);
          if (msg.type === 'log') {
            addRealtimeLog(msg.data);
            // å¦‚æœåœ¨æ¦‚è§ˆé¡µï¼Œæ›´æ–°ç»Ÿè®¡
            if (currentPage === 'overview') {
              loadStats();
            }
          } else if (msg.type === 'session_log') {
            addRealtimeSessionLog(msg.data);
            // å¦‚æœåœ¨æ¦‚è§ˆé¡µï¼Œæ›´æ–°ç»Ÿè®¡
            if (currentPage === 'overview') {
              loadStats();
            }
            // å¦‚æœåœ¨ä¼šè¯æµæ°´é¡µï¼Œåˆ·æ–°åˆ—è¡¨
            if (currentPage === 'sessions') {
              loadSessions();
            }
          }
        } catch (e) {
          console.error('è§£ææ¶ˆæ¯å¤±è´¥:', e);
        }
      };
      
      eventSource.onerror = () => {
        document.getElementById('statusDot').classList.add('disconnected');
        document.getElementById('statusText').textContent = 'æ–­å¼€';
        // 5ç§’åé‡è¿
        setTimeout(connectSSE, 5000);
      };
    }
    
    function addRealtimeLog(log) {
      const tbody = document.getElementById('realtimeLogs');
      // ç§»é™¤ç©ºçŠ¶æ€æç¤º
      const empty = tbody.querySelector('.empty');
      if (empty) empty.parentElement.remove();
      
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${formatTimeShort(log.timestamp)}</td>
        <td>${logTypeTag(log.type)}</td>
        <td title="${log.uid || ''}">${shortUid(log.uid)}</td>
        <td>${statusTag(log.status)}</td>
        <td>${log.duration ? log.duration + 'ms' : '-'}</td>
      `;
      tbody.insertBefore(tr, tbody.firstChild);
      
      // ä¿æŒæœ€å¤š50æ¡
      while (tbody.children.length > 50) {
        tbody.removeChild(tbody.lastChild);
      }
    }
    
    function addRealtimeSessionLog(session) {
      const tbody = document.getElementById('realtimeLogs');
      // ç§»é™¤ç©ºçŠ¶æ€æç¤º
      const empty = tbody.querySelector('.empty');
      if (empty) empty.parentElement.remove();
      
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${formatTimeShort(session.timestamp)}</td>
        <td>${msgTypeTag(session.msgType)}</td>
        <td title="${session.uid || ''}">${shortUid(session.uid)}</td>
        <td>${statusTag(session.status)}</td>
        <td>${session.totalDuration ? session.totalDuration + 'ms' : '-'}</td>
      `;
      tbody.insertBefore(tr, tbody.firstChild);
      
      // ä¿æŒæœ€å¤š50æ¡
      while (tbody.children.length > 50) {
        tbody.removeChild(tbody.lastChild);
      }
    }
    
    function clearRealtimeLogs() {
      document.getElementById('realtimeLogs').innerHTML = '<tr><td colspan="5" class="empty">ç­‰å¾…æ–°æ—¥å¿—...</td></tr>';
    }
    
    // å¼¹çª—
    function closeModal(event) {
      if (event && event.target !== event.currentTarget) return;
      document.getElementById('modalOverlay').classList.add('hidden');
    }
    
    // é€€å‡º
    function logout() {
      window.location.href = '/';
    }
    
    // åˆå§‹åŒ–
    document.addEventListener('DOMContentLoaded', () => {
      if (!TOKEN) {
        alert('è¯·æä¾›ç®¡ç†å‘˜Token');
        window.location.href = '/';
        return;
      }
      
      loadStats();
      connectSSE();
    });
    
    // é”®ç›˜äº‹ä»¶
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        closeModal();
      }
    });
  </script>
</body>
</html>
